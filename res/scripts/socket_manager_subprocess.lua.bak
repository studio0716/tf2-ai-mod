local M = {}

-- Path to the python bridge script. 
-- For this user's specific setup, we use the absolute path.
local BRIDGE_PATH = "/Users/lincolncarlton/Dev/local_ai_builder/native_socket/bridge.py"

function M.connect(host, port)
    -- "Connect" is a no-op in bridge mode
    return 1
end

function M.send(sock, data)
    -- Escape quotes in data for shell safety
    -- Also escape backslashes
    local safe_data = string.gsub(data, '\\', '\\\\')
    safe_data = string.gsub(safe_data, '"', '\\"')
    
    local cmd = string.format("python3 \"%s\" send \"%s\"", BRIDGE_PATH, safe_data)
    local h = io.popen(cmd, "r")
    if h then h:close() end
end

function M.receive(sock)
    local cmd = string.format("python3 \"%s\" receive", BRIDGE_PATH)
    local h = io.popen(cmd, "r")
    if h then
        local res = h:read("*a")
        h:close()
        -- Trim whitespace
        if res and #res > 0 then
            -- Remove trailing newline from print
            return string.gsub(res, "^%s*(.-)%s*$", "%1")
        end
    end
    return nil
end

function M.close(sock)
    -- No-op
end

return M
