--[[
    Socket Manager - File IPC for TF2 <-> Claude Communication

    Protocol:
    - Claude writes commands to: /tmp/tf2_llm_command.json
    - Game reads and executes commands, clears the file
    - Game writes responses to: /tmp/tf2_llm_response.json

    Command format:
    - JSON: {"command": "query_game_state", "params": {...}}
]]

local M = {}

-- Paths matching ipc_client.py
local COMMAND_FILE = "/tmp/tf2_llm_command.json"
local RESPONSE_FILE = "/tmp/tf2_llm_response.json"

-- JSON helper
local json = nil
local function get_json()
    if json then return json end
    local success, mod = pcall(require, "json")
    if success then json = mod end
    return json
end

-- Logging
local function log(msg)
    local f = io.open("/tmp/tf2_socket_manager.log", "a")
    if f then
        f:write(os.date("%H:%M:%S") .. " " .. tostring(msg) .. "\n")
        f:close()
    end
end

--[[
    Poll for command from Claude (Claude -> Game)
    Reads from /tmp/tf2_llm_command.json
    Returns: Raw content (usually JSON string), or nil
]]
function M.poll()
    local f = io.open(COMMAND_FILE, "r")
    if not f then return nil end

    local content = f:read("*a")
    f:close()

    if not content or #content == 0 then return nil end

    -- Clear the file to prevent re-processing
    local clear_f = io.open(COMMAND_FILE, "w")
    if clear_f then clear_f:close() end

    log("Got command: " .. content:sub(1, 100))
    return content
end

--[[
    Send result back to Claude (Game -> Claude)
    Writes to /tmp/tf2_llm_response.json
]]
function M.send_result(result)
    local j = get_json()
    local content
    if type(result) == "table" and j then
        content = j.encode(result)
    else
        content = tostring(result)
    end

    local f = io.open(RESPONSE_FILE, "w")
    if f then
        f:write(content)
        f:close()
        log("Wrote response: " .. content:sub(1, 100))
        return true
    end
    log("Failed to write response")
    return false
end

function M.is_daemon_running()
    return true
end

return M